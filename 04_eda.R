# Exploratory Data Analysis

plot_barplots <- function(df) {
  barplots <- df %>%
    filter(!is.na(churn)) %>%
    select(where(is.factor)) %>%
    select(-c(source)) %>%
    pivot_longer(!churn, names_to = "feature", values_to = "observation") %>%
    group_by(churn, observation, feature) %>%
    summarise(count = n()) %>%
    ungroup() %>%
    mutate(group_var = str_c(feature, observation, sep = ".")) %>%
    group_by(group_var) %>%
    mutate(total_observation_count = sum(count),
           pct_observation = count / total_observation_count) %>%
    arrange(observation) %>%
    ggplot(mapping = aes(x = observation, y = pct_observation, fill = churn)) +
    geom_col(alpha = 0.8, position = "dodge") +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~feature, scales = "free") +
    xlab("Feature Realisation") +
    ylab("Percentage of Churners vs. Non-Churners in Feature Realisation Group") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
    
  return(barplots)
}


plot_histograms <- function(df) {
  histograms <- df %>%
    # exclude the initially joined test set where "churn" is NA
    filter(!is.na(churn)) %>%
    select(churn, where(is.numeric)) %>%
    pivot_longer(!churn, names_to = "feature", values_to = "value") %>%
    ggplot(mapping = aes(value, fill = churn, alpha = 0.4)) +
    geom_histogram(show.legend = FALSE) +
    facet_wrap(~feature, scales = "free") +
    theme_bw()
  
  return(histograms)
}


plot_boxplots <- function(df) {
  boxplots <- df %>%
    # exclude the initially joined test set where "churn" is NA
    filter(!is.na(churn)) %>%
    select(churn, where(is.numeric)) %>%
    pivot_longer(!churn, names_to = "feature", values_to = "value") %>%
    ggplot(mapping = aes(x = feature, y = value, fill = churn, alpha = 0.4)) +
    geom_boxplot(show.legend = T) +
    facet_wrap(~feature, scales = "free") +
    theme_bw()
  
  return(boxplots)
}


plot_correlations <- function(df, filter_churn = TRUE, is_raw = FALSE, select_feature_subset = FALSE) {
  # subset data
  df_sub <- df %>%
    filter(
      case_when(
        filter_churn ~ !is.na(churn),
        TRUE ~ TRUE
      )
    ) %>%
    select(where(is.numeric))
  
  if(!is_raw) {
    df_sub <- df_sub %>%
      # exclude Inf vars (generated by division by 0.. --> account for in subsequent analysis)
      filter_at(vars(minutes_per_day_call:avg_charge_total_per_month), all_vars(!is.na(.)))
  }
  
  if(select_feature_subset) {
    df_sub <- df_sub %>%
      select(minutes_per_day_call:avg_charge_total_per_month)
  }
  
  # calculate correlation matrix and plot
  corr_mat <- cor(df_sub)
  corr_mat_pvalue <- cor_pmat(df_sub)
  correlation_plot <- ggcorrplot(corr_mat,
                                 hc.order = FALSE,
                                 type = "full",
                                 p.mat = corr_mat_pvalue,
                                 lab = FALSE,
                                 insig = "blank")
    
    return(correlation_plot)
}
 

# plot account length vs utiliziation 
plot_scatterplot <- function(df) {
  df %>%
    select(account_length, total_calls, total_charge, total_minutes) %>%
    pivot_longer(cols = !account_length, names_to = "metric", values_to = "value") %>%
    ggplot(mapping = aes(x = account_length, y = value, colour = metric)) +
    geom_point(alpha = 0.5, show.legend = FALSE) +
    geom_smooth(method = "lm", colour = "black", se = TRUE) + 
    facet_wrap(~metric) +
    ylab("Metric Value") +
    xlab("Membership Length") +
    theme_bw()
}
